unsigned char boot_js[] ="(()=>{var u={defines:{COF_FUNC_NMT:0,COF_FUNC_SDO_TX:11,COF_FUNC_SDO_RX:12,COF_FUNC_HEARTBEAT:14,COF_SDO_CMD_DOWNLOAD:1,COF_SDO_CMD_UPLOAD:2,COF_SDO_CMD_ABORT:4,COF_SDO_SCS_UPLOAD_REPLY:2,COF_SDO_SCS_DOWNLOAD_REPLY:3,COF_SDO_SCS_ABORT:4,COF_ABORT_TOGGLE:84082688,COF_ABORT_TIMEOUT:84148224,COF_ABORT_CMD:84148225,COF_ABORT_OUT_OF_MEM:84148229,COF_ABORT_UNSUPPORTED:100728832,COF_ABORT_WRITEONLY:100728833,COF_ABORT_READONLY:100728834,COF_ABORT_NOT_EXIST:100794368,COF_ABORT_PARAM_RANGE:101253168,COF_ABORT_GENERAL:134217728,COF_HB_BOOTUP:0,COF_HB_STOPPED:4,COF_HB_OPERATIONAL:5,COF_HB_PREOP:127},dataBits:{COF_SDO_CMD:{offs:5,len:3},COF_SDO_N_UNUSED:{offs:2,len:2},COF_SDO_EXPEDITED:{offs:1,len:1},COF_SDO_SIZE_IND:{offs:0,len:1},COF_SDO_INDEX:{offs:8,len:16},COF_SDO_SUBINDEX:{offs:24,len:8},COF_SDO_DATA_0:{offs:32,len:8},COF_SDO_DATA_1:{offs:40,len:8},COF_SDO_DATA_2:{offs:48,len:8},COF_SDO_DATA_3:{offs:56,len:8},COF_SDO_ABORT_CODE:{offs:32,len:32},COF_HEARTBEAT_STATE:{offs:0,len:8}},cobBits:{COF_FUNC:{offs:7,len:4},COF_NODE_ID:{offs:0,len:7}}};function D(i){if(i=i.trim(),i.length===0)return;let t=i[0];if(![\"t\",\"T\",\"r\",\"R\"].includes(t))return;let r=t===\"T\"||t===\"R\",s=t===\"r\"||t===\"R\";if(r){if(i.length<10)return;let n=parseInt(i.substring(1,9),16);if(Number.isNaN(n))return;let a=parseInt(i[9],16);if(Number.isNaN(a)||a<0||a>8)return;if(s)return i.length!==10?void 0:{id:n,data:new Uint8Array(0),ext:!0,rtr:!0};{let d=10+a*2;if(i.length!==d)return;let h=new Uint8Array(a),o=10;for(let l=0;l<a;l++){let f=parseInt(i.substring(o,o+2),16);if(Number.isNaN(f))return;h[l]=f,o+=2}return{id:n,data:h,ext:!0,rtr:!1}}}else{if(i.length<5)return;let n=parseInt(i.substring(1,4),16);if(Number.isNaN(n))return;let a=parseInt(i[4],16);if(Number.isNaN(a)||a<0||a>8)return;if(s)return i.length!==5?void 0:{id:n,data:new Uint8Array(0),ext:!1,rtr:!0};{let d=5+a*2;if(i.length!==d)return;let h=new Uint8Array(a),o=5;for(let l=0;l<a;l++){let f=parseInt(i.substring(o,o+2),16);if(Number.isNaN(f))return;h[l]=f,o+=2}return{id:n,data:h,ext:!1,rtr:!1}}}}function w(i){if(!i||typeof i.id!=\"number\")return;let t=i.id,r=!!i.ext,s=!!i.rtr,n=0,a=[];if(!s&&i.data!=null){let f=i.data;if(ArrayBuffer.isView(f))n=Math.min(f.length,8),a=Array.from(f.slice(0,n));else if(Array.isArray(f))n=Math.min(f.length,8),a=f.slice(0,n);else return}let d=s?r?\"R\":\"r\":r?\"T\":\"t\",h=r?t.toString(16).padStart(8,\"0\").toUpperCase().slice(-8):t.toString(16).padStart(3,\"0\").toUpperCase().slice(-3),o=n.toString(16).toUpperCase(),l=\"\";return!s&&n>0&&(l=a.map(f=>f.toString(16).padStart(2,\"0\").toUpperCase()).join(\"\")),d+h+o+l}function b(i,t,r){let s=0;for(let n=0;n<r;n++){let a=t+n,d=a>>3,h=a&7;i[d]&1<<h&&(s|=1<<n)}return s>>>0}function p(i,t,r,s){for(let n=0;n<r;n++){let a=t+n,d=a>>3,o=1<<(a&7);s&1<<n?i[d]|=o:i[d]&=~o}}function T(i,t){t[0]=i>>>0&255,t[1]=i>>>8&255,t[2]=i>>>16&255,t[3]=i>>>24&255}function N(i){return(i[0]<<0|i[1]<<8|i[2]<<16|i[3]<<24)>>>0}var e=class i{constructor(t){this.id=0,this.data=new Uint8Array(8),typeof t==\"string\"?Object.assign(this,D(t)):t&&Object.assign(this,t)}set(t,r){if(t in i.cobBits){let s=i.cobBits[t],n=new Uint8Array(4);T(this.id,n),p(n,s.offs,s.len,r),this.id=N(n)&2047;return}if(t in i.dataBits){let s=i.dataBits[t];s.len<32&&(r&=(1<<s.len)-1),p(this.data,s.offs,s.len,r);return}switch(t){case\"COF_COB_ID\":cof.id=r;return;case\"COF_DLC\":throw new Error(\"WIP\")}throw new Error(`write unknown prop: ${t}`)}toSlcan(t){return w(this)}get(t){if(t in i.cobBits){let r=i.cobBits[t],s=new Uint8Array(4);return T(this.id,s),b(s,r.offs,r.len)}if(t in i.dataBits){let r=i.dataBits[t];return b(this.data,r.offs,r.len)}switch(t){case\"COF_COB_ID\":return this.id;case\"COF_DLC\":return this.data.length}throw new Error(`read unknown prop: ${t}`)}};for(let i in u.defines)e[i]=u.defines[i];for(let i in u.dataBits)e[i]=i;for(let i in u.cobBits)e[i]=i;e.dataBits=u.dataBits;e.cobBits=u.cobBits;e.sdoErrors={};e.sdoErrors[e.COF_ABORT_TOGGLE]=\"Toggle bit not alternated\";e.sdoErrors[e.COF_ABORT_TIMEOUT]=\"SDO protocol timed out\";e.sdoErrors[e.COF_ABORT_COMMAND]=\"Command specifier not valid or unknown\";e.sdoErrors[e.COF_ABORT_OUT_OF_MEMORY]=\"Out of memory\";e.sdoErrors[e.COF_ABORT_UNSUPPORTED_ACCESS]=\"Unsupported access to an object\";e.sdoErrors[e.COF_ABORT_NOT_EXIST]=\"Object does not exist in OD\";e.sdoErrors[e.COF_ABORT_READONLY]=\"Attempt to write a read-only object\";e.sdoErrors[e.COF_ABORT_TYPE_MISMATCH]=\"Data type does not match\";e.sdoErrors[e.COF_ABORT_LENGTH_EXCEEDED]=\"Length of service parameter too high\";e.sdoErrors[e.COF_ABORT_SUBINDEX]=\"Subindex does not exist\";e.sdoErrors[e.COF_ABORT_DEVICE_STATE]=\"Device internal error\";function O(i,t,r,s){return new Promise((n,a)=>{let d;function h(){clearTimeout(d),i.off(t,o)}function o(...l){try{let f=r(...l);f&&(h(),n(f))}catch(f){h(),a(f)}}i.on(t,o),s&&(d=setTimeout(()=>{h(),n()},s))})}var _=class{constructor(){this._e={}}on(t,r){this._e[t]||(this._e[t]=[]),this._e[t].push(r)}off(t,r){let s=this._e[t];if(!s)return;let n=s.indexOf(r);n!==-1&&s.splice(n,1),s.length===0&&delete this._e[t]}emit(t,r){let s=this._e[t];if(s)for(let n of[...s])n(r)}},S=class{constructor(){this._locked=!1,this._queue=[]}async critical(t){this._locked&&await new Promise(r=>this._queue.push(r)),this._locked=!0;try{return await t()}finally{this._locked=!1;let r=this._queue.shift();r&&r()}}};var F=class extends _{constructor(t,r){super(),this.index=t,this.subIndex=r,this.setType(\"int32\")}getTypeSize(){switch(this.type){case\"int8\":case\"uint8\":case\"bool\":return 1;case\"int16\":case\"uint16\":return 2;case\"int32\":case\"uint32\":case\"float32\":return 4;case\"string\":return 0;default:throw new Error(\"Unknown type: \"+this.type)}}setType(t){return this.type=t,this.buffer=new ArrayBuffer(this.getTypeSize()),this.view=new DataView(this.buffer),this.view8=new Uint8Array(this.buffer),this}subscribe({interval:t,pdoChannel:r}={}){return this.subscribeInterval&&clearInterval(this.subscribeInterval),t&&(this.subscribeInterval=setInterval(async()=>{let s=this.get();await this.refresh(),this.get()!=s&&this.emit(\"change\")},t)),r&&this.device.entry(6656+r-1,1).setData([32,this.subIndex,this.index&255,this.index>>8]),this}async expeditedRead(){let t=new e;t.set(e.COF_FUNC,e.COF_FUNC_SDO_RX),t.set(e.COF_NODE_ID,this.device.getNodeId()),t.set(e.COF_SDO_CMD,e.COF_SDO_CMD_UPLOAD),t.set(e.COF_SDO_INDEX,this.index),t.set(e.COF_SDO_SUBINDEX,this.subIndex),this.device.getBus().send(t),await O(this.device.getBus(),\"message\",r=>{let s=new e(r);if(s.get(e.COF_FUNC)==e.COF_FUNC_SDO_TX&&s.get(e.COF_SDO_CMD)==e.COF_SDO_SCS_UPLOAD_REPLY&&s.get(e.COF_SDO_INDEX)==this.index&&s.get(e.COF_SDO_SUBINDEX)==this.subIndex){let n=4-s.get(e.COF_SDO_N_UNUSED),a=new Uint8Array(this.buffer);for(let d=0;d<n;d++)a[d]=s.data[4+d];return!0}if(s.get(e.COF_FUNC)==e.COF_FUNC_SDO_TX&&s.get(e.COF_SDO_CMD)==e.COF_SDO_CMD_ABORT&&s.get(e.COF_SDO_INDEX)==this.index&&s.get(e.COF_SDO_SUBINDEX)==this.subIndex)throw new Error(e.sdoErrors[s.get(e.COF_SDO_ABORT_CODE)])})}async expeditedWrite(){let t=Math.min(4,this.buffer.byteLength),r=new e;r.set(e.COF_FUNC,e.COF_FUNC_SDO_RX),r.set(e.COF_NODE_ID,this.device.getNodeId()),r.set(e.COF_SDO_CMD,e.COF_SDO_CMD_DOWNLOAD),r.set(e.COF_SDO_EXPEDITED,1),r.set(e.COF_SDO_SIZE_IND,1),r.set(e.COF_SDO_N_UNUSED,4-t),r.set(e.COF_SDO_INDEX,this.index),r.set(e.COF_SDO_SUBINDEX,this.subIndex);let s=new Uint8Array(this.buffer);for(let h=0;h<t;h++)r.data[4+h]=s[h];let n,a=250,d=0;for(;!n;){if(d++,d>4)throw new Error(\"expedited write timed out\");this.device.getBus().send(r),n=await O(this.device.getBus(),\"message\",h=>{let o=new e(h);if(o.get(e.COF_FUNC)==e.COF_FUNC_SDO_TX&&o.get(e.COF_SDO_CMD)==e.COF_SDO_SCS_DOWNLOAD_REPLY&&o.get(e.COF_SDO_INDEX)==this.index&&o.get(e.COF_SDO_SUBINDEX)==this.subIndex)return!0;if(o.get(e.COF_FUNC)==e.COF_FUNC_SDO_TX&&o.get(e.COF_SDO_CMD)==e.COF_SDO_SCS_ABORT&&o.get(e.COF_SDO_INDEX)==this.index&&o.get(e.COF_SDO_SUBINDEX)==this.subIndex)throw new Error(e.sdoErrors[o.get(e.COF_SDO_ABORT_CODE)])},a),a*=2}this.emit(\"written\",this)}set(t){switch(this.type){case\"int8\":this.view.setInt8(0,t,!0);break;case\"uint8\":this.view.setUint8(0,t,!0);break;case\"int16\":this.view.setInt16(0,t,!0);break;case\"uint16\":this.view.setUint16(0,t,!0);break;case\"int32\":this.view.setInt32(0,t,!0);break;case\"uint32\":this.view.setUint32(0,t,!0);break;case\"float32\":this.view.setFloat32(0,t,!0);break;case\"bool\":this.view.setUint8(0,t?1:0,!0);break;case\"string\":throw new Error(\"WIP!!!\");default:throw new Error(\"Unsupported type: \"+this.type)}return this.device&&this.device.notifyDirty(this),this}setData(t){for(let r=0;r<t.length;r++)this.view8[r]=t[r];return this.device&&this.device.notifyDirty(this),this}get(){switch(this.type){case\"int8\":return this.view.getInt8(0,!0);case\"uint8\":return this.view.getUint8(0,!0);case\"int16\":return this.view.getInt16(0,!0);case\"uint16\":return this.view.getUint16(0,!0);case\"int32\":return this.view.getInt32(0,!0);case\"uint32\":return this.view.getUint32(0,!0);case\"float32\":return this.view.getFloat32(0,!0);case\"bool\":return!!this.view.getUint8(0,!0);case\"string\":throw new Error(\"WIP!!!\");default:throw new Error(\"Unsupported type: \"+this.type)}}async refresh(){await this.expeditedRead()}};var c=class extends _{constructor({nodeId:t,bus:r}={}){if(super(),r)throw new Error(\"RemoteDevice should no be created with bus!\");if(!t)throw new Error(\"Need node id!\");this.entries=[],this.nodeId=t,this.state=\"disconnected\",this.entry(6656,1),this.entry(6657,1),this.entry(6658,1),this.entry(6659,1),this.dirtyEntries=[],this.writeSemaphore=new S}setMasterDevice(t){this.getBus()&&this.getBus().off(\"message\",this.handleMessage),this.masterDevice=t,this.getBus()&&this.getBus().on(\"message\",this.handleMessage),this.state=\"disconnected\"}getBus(){if(this.masterDevice)return this.masterDevice.getBus()}handleMessage=t=>{let r=new e(t);if(r.get(e.COF_FUNC)==e.COF_FUNC_HEARTBEAT&&r.get(e.COF_NODE_ID)==this.getNodeId()){let s=r.get(e.COF_HEARTBEAT_STATE),n;s===e.COF_HB_OPERATIONAL?n=\"operational\":n=\"unknown\",n!=this.state&&(this.state=n,this.emit(\"stateChange\",this.state)),this.heartbeatTimeout&&clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=setTimeout(this.handleHeartbeatTimeout,3e3)}for(let s=0;s<4;s++){let n=384+s*256+this.nodeId;if(t.id==n){let a=this.entry(6656+s,1),d=a.view8[0],h=a.view8[1],o=a.view8[2]+(a.view8[3]<<8),l=this.entry(o,h);l.view8[0]=t.data[0],l.view8[1]=t.data[1],l.view8[2]=t.data[2],l.view8[3]=t.data[3],l.emit(\"change\")}}};handleHeartbeatTimeout=()=>{this.heartbeatTimeout=null,this.state=\"disconnected\",this.emit(\"stateChange\",this.state)};getNodeId(){if(!this.nodeId)throw new Error(\"No node id!\");return this.nodeId}entry(t,r){for(let n of this.entries)if(n.index==t&&n.subIndex==r)return n;let s=new F(t,r);return s.device=this,this.entries.push(s),s}getState(){return this.state}async awaitState(t){this.state!=t&&await O(this,\"stateChange\",r=>{if(this.state==t)return!0})}async processDirty(){this.writeSemaphore.critical(async()=>{if(this.awaitState(\"operational\"),!this.dirtyEntries.length)return;let t=this.dirtyEntries.shift();this.dirtyEntryInProgress=t,await t.expeditedWrite(),this.dirtyEntryInProgress=void 0})}notifyDirty(t){this.dirtyEntries.includes(t)||(this.dirtyEntries.push(t),this.processDirty())}flush(){return new Promise((t,r)=>{let s=[...this.dirtyEntries];if(this.dirtyEntryInProgress&&s.push(this.dirtyEntryInProgress),!s.length){t();return}function n(){for(let h of s)h.off(\"written\",d)}let a=[...s];function d(h){let o=a.indexOf(h);o>=0&&a.splice(o,1),a.length||(n(),t())}for(let h of s)h.on(\"written\",d)})}};var E=class{constructor({bus:t,nodeId:r}={}){if(!t||!r)throw new Error(\"Need bus and node id!\");this.bus=t,this.nodeId=r,this.sendHeartbeatInterval=setInterval(this.handleSendHeartbeatInterval,1e3)}handleSendHeartbeatInterval=()=>{let t=new e;t.set(e.COF_FUNC,e.COF_FUNC_HEARTBEAT),t.set(e.COF_NODE_ID,this.getNodeId()),t.set(e.COF_HEARTBEAT_STATE,e.COF_HB_OPERATIONAL),this.bus.send(t)};getNodeId(){if(!this.nodeId)throw new Error(\"No node id!\");return this.nodeId}getBus(){return this.bus}};var C=class extends E{constructor({bus:t}={}){if(!t)throw new Error(\"MasterDevice: need bus!\");super({bus:t,nodeId:1}),this.devices=[]}addDevice(t){t.setMasterDevice(this),this.devices.push(t)}};function y(i){try{return JSON.parse(i)}catch{}}var g=class extends _{constructor(t){super(),this.serial=t,this.line=\"\",this.serial.on(\"data\",r=>{for(let s of r)this.handleInput(s)}),this.on(\"line\",r=>this.handleLine(r)),this.prompt()}prompt(){this.serial.write(\"> \"),this.line=\"\"}handleLine(t){try{let r=global.eval(t);this.serial.write(String(r)),this.serial.write(`\n`)}catch(r){this.serial.write(`\n`),this.serial.write(`\n`),this.serial.write(`\n`),this.serial.write(\"Line: \"+t),this.serial.write(`\n`),this.serial.write(\"The Error: \"+r.message),this.serial.write(`\n`)}}handleInput(t){if(t=String(t),t===\"\"){this.serial.write(`^C\n`),this.prompt();return}if(t===`\n`){this.serial.write(`\n`);let r=y(this.line);r&&this.line.trim().startsWith(\"{\")?this.emit(\"message\",r):this.line.trim().length&&this.emit(\"line\",this.line),this.line=\"\",this.prompt();return}if(t===\"\b\"||t===\"\x7F\"){this.line.length>0&&(this.line=this.line.slice(0,-1),this.serial.write(\"\b \b\"));return}this.line+=t,this.serial.write(t)}};global.awaitEvent=O;global.EventEmitter=_;global.RemoteDevice=c;global.MasterDevice=C;global.serial=new _;serial.write=i=>serialWrite(i);setSerialDataFunc(i=>serial.emit(\"data\",i));global.console={};console.log=(...i)=>serialWrite(i.map(t=>String(t)).join(\" \")+`\r\n`);repl=new g(serial);repl.on(\"message\",i=>{if(!(i.type!=\"call\"&&!i.method))try{let t=global[i.method](...i.params);serial.write(JSON.stringify({id:i.id,result:t})+`\n`)}catch(t){serial.write(JSON.stringify({id:i.id,error:{message:String(t)}})+`\n`)}});global.canBus=new _;global.canBus.write=i=>{let t=w(i);canWrite(t)};global.canBus.send=global.canBus.write;setCanMessageFunc(i=>{global.canBus.emit(\"message\",D(i))});})();\n";
